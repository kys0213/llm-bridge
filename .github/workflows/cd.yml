name: CD (Continuous Deployment)

on:
  push:
    branches: [main]
  workflow_dispatch: # ìˆ˜ë™ íŠ¸ë¦¬ê±° í—ˆìš©

# ë™ì‹œ ë°°í¬ ë°©ì§€
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ë°°í¬ ì „ ê²€ì¦
  pre-deploy-checks:
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.check-changes.outputs.should-deploy }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # HEADì™€ HEAD~1 ë¹„êµë¥¼ ìœ„í•´ í•„ìš”
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: 'https://registry.npmjs.org'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm store
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check for package changes
        id: check-changes
        run: |
          echo "ë³€ê²½ì‚¬í•­ í™•ì¸ ì¤‘..."

          # packages ë””ë ‰í† ë¦¬ì˜ ë³€ê²½ì‚¬í•­ í™•ì¸
          if git diff --name-only HEAD~1 HEAD | grep -q "^packages/"; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… packages ë””ë ‰í† ë¦¬ì— ë³€ê²½ì‚¬í•­ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ packages ë””ë ‰í† ë¦¬ì— ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤. ë°°í¬ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
          fi

      - name: Lint check
        if: steps.check-changes.outputs.should-deploy == 'true'
        run: pnpm lint

      - name: Format check with detailed output
        if: steps.check-changes.outputs.should-deploy == 'true'
        run: ./scripts/format-check.sh

      - name: Type check and build
        if: steps.check-changes.outputs.should-deploy == 'true'
        run: pnpm build

      - name: Run unit tests (skip E2E)
        if: steps.check-changes.outputs.should-deploy == 'true'
        run: pnpm test:ci

  # ë©”ì¸ ë°°í¬ ìž‘ì—…
  deploy:
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    if: needs.pre-deploy-checks.outputs.should-deploy == 'true'

    environment:
      name: production
      url: https://www.npmjs.com/~llm-bridge

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ì „ì²´ ížˆìŠ¤í† ë¦¬ í•„ìš”
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: 'https://registry.npmjs.org'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm store
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm build

      - name: Run deployment script
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: ./scripts/deploy.sh

      - name: Create deployment summary
        if: always()
        run: |
          echo "## ðŸš€ ë°°í¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "ë°°í¬ ì¼ì‹œ: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "ë¸Œëžœì¹˜: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "ì»¤ë°‹: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ë°°í¬ëœ íŒ¨í‚¤ì§€ë“¤" >> $GITHUB_STEP_SUMMARY
          echo "ë³€ê²½ëœ íŒ¨í‚¤ì§€ë“¤ì´ npmì— ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY

  # ë°°í¬ ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
  notify-failure:
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks, deploy]
    if: failure() && needs.pre-deploy-checks.outputs.should-deploy == 'true'

    steps:
      - name: Create failure notification
        run: |
          echo "## âŒ ë°°í¬ ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          echo "ë°°í¬ ê³¼ì •ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          echo "ì‹¤íŒ¨ ì¼ì‹œ: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "ë¸Œëžœì¹˜: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "ì»¤ë°‹: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
